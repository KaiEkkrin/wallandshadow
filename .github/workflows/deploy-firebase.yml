# =============================================================================
# Wall & Shadow - Reusable Firebase Deployment Workflow
# =============================================================================
#
# This is a REUSABLE WORKFLOW that contains the shared deployment logic for
# deploying Wall & Shadow to Firebase. It's called by environment-specific
# workflows (deploy-test.yml, deploy-production.yml).
#
# DO NOT trigger this workflow directly. Use the environment-specific workflows.
#
# =============================================================================
# ARCHITECTURE
# =============================================================================
#
# This workflow uses GitHub's reusable workflow pattern:
#   https://docs.github.com/en/actions/using-workflows/reusing-workflows
#
# Benefits:
#   - DRY: Deployment logic defined once, used by multiple environments
#   - Maintainability: Changes to deployment process only need to be made here
#   - Flexibility: Environment-specific workflows can customize triggers/conditions
#   - Clarity: Environment differences are explicit in caller workflows
#
# Caller workflows:
#   - .github/workflows/deploy-test.yml (auto-deploy on push to main)
#   - .github/workflows/deploy-production.yml (manual trigger only)
#
# =============================================================================
# SETUP INSTRUCTIONS
# =============================================================================
#
# Each environment (test, production) requires a GitHub Environment with secrets.
# Replace YOUR_PROJECT_ID with your actual Firebase project ID throughout.
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ STEP 1: Create the GitHub Environment                                   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# 1. Go to your GitHub repository
# 2. Click "Settings" tab
# 3. In left sidebar: "Environments"
# 4. Click "New environment"
# 5. Name: "test" or "production"
# 6. Click "Configure environment"
# 7. Configure protection rules:
#    - Test: Optional (you probably DON'T want required reviewers)
#    - Production: RECOMMENDED - limit to "main" branch, add required reviewers
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ STEP 2: Generate Firebase Service Account Key                           â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# 1. Go to Firebase Console: https://console.firebase.google.com
# 2. Select your project
# 3. Click the gear icon (âš™ï¸) â†’ "Project settings"
# 4. Navigate to the "Service Accounts" tab
# 5. Click "Generate New Private Key" button
# 6. Click "Generate Key" to confirm
# 7. A JSON file will download
#    âš ï¸  KEEP THIS FILE SECURE - It contains sensitive credentials!
#
# IMPORTANT: Generating a new key does NOT invalidate old keys!
# Old keys remain valid until you explicitly delete them.
#
# âš ï¸  Use SEPARATE service accounts for test and production environments!
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ STEP 3: Add Required Roles to Service Account                           â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# 1. Go to: https://console.cloud.google.com/iam-admin/iam?project=YOUR_PROJECT_ID
# 2. Find your Firebase Admin SDK service account:
#    firebase-adminsdk-xxxxx@YOUR_PROJECT_ID.iam.gserviceaccount.com
# 3. Click the âœï¸ (pencil/edit) icon
# 4. Click "Add Another Role"
# 5. Search for and select: "Firebase Admin"
# 6. Click "Save"
# 7. Repeat the above steps to also add any of the following roles if
# they are not already present: "Service Account Token Creator", "Service Account
# User", "Storage Admin"
# 8. Wait 2-5 minutes for IAM changes to propagate
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ STEP 4: Encode and Add FIREBASE_SERVICE_ACCOUNT Secret                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# On Linux/macOS/WSL:
#   1. Open terminal
#   2. Navigate to where you downloaded the JSON file
#   3. Encode it to base64:
#        cat YOUR_PROJECT_ID-firebase-adminsdk-xxxxx.json | base64 -w 0 > encoded.txt
#      (The -w 0 flag prevents line wrapping)
#   4. Copy the contents of encoded.txt
#   5. DELETE the original JSON file and encoded.txt after adding to GitHub
#
# On Windows PowerShell:
#   1. Open PowerShell
#   2. Navigate to where you downloaded the JSON file
#   3. Encode it to base64:
#        [Convert]::ToBase64String([IO.File]::ReadAllBytes("YOUR_PROJECT_ID-firebase-adminsdk-xxxxx.json")) | Out-File -Encoding ASCII encoded.txt
#   4. Copy the contents of encoded.txt
#   5. DELETE the original JSON file and encoded.txt after adding to GitHub
#
# ADD TO GITHUB ENVIRONMENT SECRETS:
#   1. Go to your GitHub repository â†’ Settings â†’ Environments â†’ [your environment]
#   2. Under "Environment secrets", click "Add secret"
#   3. Name: FIREBASE_SERVICE_ACCOUNT
#   4. Value: Paste the base64-encoded string (the contents of encoded.txt)
#   5. Click "Add secret"
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ STEP 5: Add FIREBASE_PROJECT_ID Secret                                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# HOW TO FIND YOUR PROJECT ID:
#   Option 1: From Firebase Console
#     - Open Firebase Console: https://console.firebase.google.com
#     - Select your project
#     - The project ID is shown under the project name at the top
#
#   Option 2: From your local .firebaserc file
#     - Look in was-web/.firebaserc
#     - Use the appropriate alias ("default" for test, "production" for prod)
#
# ADD TO GITHUB ENVIRONMENT SECRETS:
#   1. Go to your GitHub repository â†’ Settings â†’ Environments â†’ [your environment]
#   2. Under "Environment secrets", click "Add secret"
#   3. Name: FIREBASE_PROJECT_ID
#   4. Value: Your Firebase project ID
#   5. Click "Add secret"
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ ONE-TIME SETUP: Cloud Storage Trigger Permissions                       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# If deploying Cloud Storage-triggered functions (like onUpload), you must
# grant the Cloud Storage service agent the Pub/Sub Publisher role. This is
# a ONE-TIME setup per project. Without this, you'll get:
#   "Failed to configure trigger providers/cloud.storage/eventTypes/object.change"
#
# OPTION A: Using Google Cloud Console (Recommended)
# ---------------------------------------------------
# 1. Go to: https://console.cloud.google.com/iam-admin/iam?project=YOUR_PROJECT_ID
# 2. Check "Include Google-provided role grants" checkbox
# 3. Find the Cloud Storage service agent:
#    service-PROJECT_NUMBER@gs-project-accounts.iam.gserviceaccount.com
#    (Note: PROJECT_NUMBER is numeric, not the project ID)
# 4. Click the âœï¸ (pencil/edit) icon
# 5. Click "Add Another Role"
# 6. Search for and select: "Pub/Sub Publisher" (roles/pubsub.publisher)
# 7. Click "Save"
# 8. Wait 2-5 minutes for IAM changes to propagate
#
# OPTION B: Using gcloud CLI
# --------------------------
# Run these commands (requires gcloud CLI installed and authenticated):
#
#   # Get your project number
#   PROJECT_NUMBER=$(gcloud projects describe YOUR_PROJECT_ID --format="value(projectNumber)")
#
#   # Grant Pub/Sub Publisher role to Cloud Storage service agent
#   gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
#     --member="serviceAccount:service-${PROJECT_NUMBER}@gs-project-accounts.iam.gserviceaccount.com" \
#     --role="roles/pubsub.publisher"
#
# For more details, see:
# https://cloud.google.com/functions/docs/calling/storage
#
# =============================================================================
# SECURITY NOTES
# =============================================================================
#
# âœ… DO:
#   - Rotate service account keys every 90 days (regenerate and update secret)
#   - Use SEPARATE service accounts for test and production environments
#   - Delete service account keys from your local machine after adding to GitHub
#   - Review GitHub's audit log periodically for secret access
#   - Set up Firebase budget alerts to monitor usage
#   - Test thoroughly in test environment before deploying to production
#
# âŒ DON'T:
#   - Never commit the service account JSON to git (it's in .gitignore)
#   - Don't use the same service account across multiple repositories
#   - Don't share the base64-encoded secret outside of GitHub
#   - Don't grant more permissions than necessary to the service account
#
# =============================================================================

name: Deploy to Firebase (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (test, production)"
        required: true
        type: string

# Least-privilege permissions: only read access to repository contents
# Deployment to Firebase is handled via service account credentials (not GITHUB_TOKEN)
# See: https://docs.github.com/en/actions/security-guides/automatic-token-authentication
permissions:
  contents: read

env:
  # Pin firebase-tools version to match development environment
  # Update this when upgrading Firebase CLI
  FIREBASE_TOOLS_VERSION: "15.1.0"

jobs:
  deploy:
    name: Build and Deploy to Firebase (${{ inputs.environment }})
    runs-on: ubuntu-latest

    # Reference the environment to access environment-scoped secrets
    # This also enables deployment tracking in GitHub UI
    environment: ${{ inputs.environment }}

    steps:
      # -----------------------------------------------------------------------
      # Checkout code
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Setup Node.js environment
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "yarn"
          cache-dependency-path: |
            was-web/yarn.lock
            was-web/functions/yarn.lock

      # -----------------------------------------------------------------------
      # Install dependencies
      # -----------------------------------------------------------------------
      - name: Install dependencies (web)
        working-directory: was-web
        run: yarn install --frozen-lockfile

      - name: Install dependencies (functions)
        working-directory: was-web/functions
        run: yarn install --frozen-lockfile

      # -----------------------------------------------------------------------
      # Build Cloud Functions
      # -----------------------------------------------------------------------
      - name: Build Cloud Functions
        working-directory: was-web/functions
        run: yarn build

      # -----------------------------------------------------------------------
      # Create mock Firebase credentials for build
      # -----------------------------------------------------------------------
      # The web app looks for firebase-admin-credentials.json during build
      # (there's a symlink in public/ pointing to this file).
      # In production, the app uses Firebase Hosting's auto-config instead.
      # We create a minimal mock file here just to satisfy the build process.
      #
      - name: Create mock Firebase credentials
        working-directory: was-web
        run: |
          echo '{"project_id": "demo-project"}' > firebase-admin-credentials.json

      # -----------------------------------------------------------------------
      # Build web application
      # -----------------------------------------------------------------------
      - name: Build web application
        working-directory: was-web
        env:
          VITE_DEPLOY_ENV: ${{ inputs.environment }}
        run: yarn build

      # -----------------------------------------------------------------------
      # Decode service account credentials
      # -----------------------------------------------------------------------
      # The service account JSON is stored as a base64-encoded GitHub secret
      # to avoid issues with special characters and secret redaction in logs.
      # We decode it here and write to a temporary file that Firebase CLI can use.
      #
      - name: Decode Firebase service account
        working-directory: was-web
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" | base64 --decode > firebase-service-account.json
          echo "âœ… Service account credentials decoded"

      # -----------------------------------------------------------------------
      # Cache npm (for firebase-tools)
      # -----------------------------------------------------------------------
      - name: Cache npm (for firebase-tools)
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-firebase-tools-${{ env.FIREBASE_TOOLS_VERSION }}

      # -----------------------------------------------------------------------
      # Install Firebase CLI
      # -----------------------------------------------------------------------
      - name: Install Firebase CLI
        run: npm install -g firebase-tools@${{ env.FIREBASE_TOOLS_VERSION }}

      # -----------------------------------------------------------------------
      # Deploy to Firebase
      # -----------------------------------------------------------------------
      # Deploy all Firebase services:
      #   - Hosting (web app)
      #   - Cloud Functions
      #   - Firestore security rules
      #   - Firestore indexes
      #   - Storage security rules
      #
      # The GOOGLE_APPLICATION_CREDENTIALS environment variable tells Firebase
      # CLI where to find the service account credentials.
      #
      # Environment-specific configuration:
      #   - Test environment uses firebase.test.json (includes X-Robots-Tag headers)
      #   - Production uses firebase.json (default, no X-Robots-Tag)
      #
      # The --force flag:
      #   - Automatically sets up Artifact Registry cleanup policies
      #   - Required in Firebase CLI v14+ to avoid deployment failures
      #
      - name: Deploy to Firebase
        working-directory: was-web
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/was-web/firebase-service-account.json
        run: |
          if [ "${{ inputs.environment }}" = "test" ]; then
            firebase deploy --force --config firebase.test.json --project ${{ secrets.FIREBASE_PROJECT_ID }}
          else
            firebase deploy --force --project ${{ secrets.FIREBASE_PROJECT_ID }}
          fi

      # -----------------------------------------------------------------------
      # Update version in Firestore
      # -----------------------------------------------------------------------
      # Writes current version to config/version document so connected
      # clients know to reload for the new version.
      #
      - name: Update version in Firestore
        working-directory: was-web
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/was-web/firebase-service-account.json
        run: node scripts/update-version.js

      # -----------------------------------------------------------------------
      # Cleanup
      # -----------------------------------------------------------------------
      # Remove the decoded service account file for security
      # (GitHub Actions runners are ephemeral, but good practice)
      #
      - name: Cleanup credentials
        if: always()
        working-directory: was-web
        run: |
          if [ -f firebase-service-account.json ]; then
            rm firebase-service-account.json
            echo "âœ… Credentials cleaned up"
          fi

      # -----------------------------------------------------------------------
      # Deployment complete
      # -----------------------------------------------------------------------
      - name: Deployment summary
        if: success()
        run: |
          echo "ðŸš€ Deployment successful to ${{ inputs.environment }} environment!"
          echo ""
          echo "Your app should be live at:"
          echo "  https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          echo "  https://${{ secrets.FIREBASE_PROJECT_ID }}.firebaseapp.com"
          echo ""
          echo "Deployed services:"
          echo "  âœ… Firebase Hosting"
          echo "  âœ… Cloud Functions"
          echo "  âœ… Firestore Rules"
          echo "  âœ… Firestore Indexes"
          echo "  âœ… Storage Rules"
          echo "  âœ… Version updated in Firestore (clients will auto-reload)"
